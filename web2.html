<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¹„ì¶©ëŒ ë°ì´í„° MAP</title>
  <!-- êµ¬ê¸€ í°íŠ¸/ì•„ì´ì½˜ -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  
  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Google Maps + MarkerCluster -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB86fhLyjTezPAfXW6Y1qPAZkDeyfoTmk8" async defer></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js" async></script>
  
  <!-- Firebase App ë° Firebase Auth (compat ë²„ì „) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script>
// ê°œë°œì ë„êµ¬ ê²½ê³  ë©”ì‹œì§€
console.log("%cì´ ì½˜ì†”ì„ ì—´ì§€ ë§ˆì„¸ìš”!", "color: red; font-size: 20px;");

// F12, Ctrl+Shift+I ì°¨ë‹¨
document.addEventListener('keydown', function(e) {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
        e.preventDefault();
    }
});
</script>
  
  <style>
    /* ê¸°ë³¸ ë¦¬ì…‹ */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: 'Roboto', sans-serif;
    }
    html, body {
      width: 100%; 
      height: 100%; 
      background: #f5f5f5; 
      overflow: hidden;
    }
    .wrapper {
      display: flex; 
      flex-direction: column; 
      width: 100%; 
      height: 100%;
    }
    /* í—¤ë” */
    .header {
      height: 110px; 
      background: #fff; 
      display: flex; 
      align-items: center;
      padding: 0 1rem; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      flex-shrink: 0;
    }
    .header .left-menu {
      display: flex; 
      align-items: center;
    }
    .menu-icon {
      cursor: pointer; 
      margin-right: 1rem;
    }
    .header-logo {
      width: 100px; 
      height: 110px; 
      margin-right: 1rem;
    }
    .title {
      font-size: 1.2rem; 
      font-weight: 500;
    }
    
    /* ë©”ì¸ ì˜ì—­ */
    .content {
      flex: 1; 
      overflow: auto; 
      background: #fff; 
      padding: 1rem; 
      position: relative; 
      z-index: 1; 
    }
    .page-section { 
      display: none; 
    }
    .page-section.active { 
      display: block; 
    }
    
    /* GRID í˜ì´ì§€ */
    #gridPanel {
      margin-bottom: 20px; 
      padding: 10px; 
      border: 1px solid #ccc; 
      background: #fafafa;
      display: flex; 
      flex-direction: column; 
      gap: 5px;
    }
    .search-row, .control-row {
      display: flex; 
      align-items: center; 
      gap: 20px; 
      flex-wrap: wrap;
    }
    .search-row .input-group, 
    .control-row .input-group {
      display: flex; 
      align-items: center; 
      gap: 5px;
    }
    #gridPanel label {
      margin-right: 5px;
    }
    #gridPanel button {
      padding: 5px 10px; 
      background: #3498db; 
      color: #fff; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
    }
    #gridPanel button:hover {
      background: #2980b9;
    }
    /* "XXê°œ ë¡œë“œë¨" í‘œì‹œ */
    #loadCountLabel {
      margin-left: auto; 
      font-size: 0.9rem; 
      color: #666;
    }
    /* ì§€ë„ */
    #map {
      margin-top: 60px;
      width: 100%; 
      height: 900px; 
      background: #ddd;
    }
    /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
    .sidebar {
      position: fixed; top: 0; left: 0; width: 260px; height: 100%;
      background: #2c3e50; color: #ecf0f1; transform: translateX(-260px);
      transition: transform 0.3s ease; z-index: 999; display: flex; flex-direction: column;
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header {
      background: #34495e; padding: 1rem; display: flex; align-items: center; justify-content: space-between;
    }
    .sidebar-header .logo { display: flex; align-items: center; font-weight: bold; font-size: 1.2rem; }
    .sidebar-header .logo img { display: none; }
    .close-btn { cursor: pointer; font-size: 1.4rem; color: #ecf0f1; background: none; border: none; }
    .menu-group { padding: 1rem; }
    .menu-title { font-size: 0.85rem; text-transform: uppercase; font-weight: 600; margin-bottom: 0.3rem; opacity: 0.7; }
    .submenu-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.5rem; cursor: pointer; margin-top: 0.5rem; border-radius: 4px;
      background: #3b4a58; transition: background 0.2s;
    }
    .submenu-toggle:hover { background: #4a5966; }
    .submenu-toggle span { display: flex; align-items: center; }
    .submenu-toggle i { margin-right: 0.3rem; }
    .submenu {
      max-height: 0; overflow: hidden; transition: max-height 0.3s ease; margin-left: 0.5rem;
    }
    .submenu.open { max-height: 200px; }
    .submenu-item {
      padding: 0.3rem 1rem; display: flex; align-items: center; cursor: pointer;
      border-radius: 4px; margin: 0.2rem 0; transition: background 0.2s;
    }
    .submenu-item:hover { background: #4a5966; }
    .submenu-item .circle {
      width: 14px; height: 14px; border-radius: 50%; border: 2px solid #ecf0f1; margin-right: 0.5rem;
    }
    .submenu-item.active .circle { background: #ecf0f1; }
    /* ìš°ì¸¡ ìƒì„¸ íŒ¨ë„ */
    .info-panel {
      position: fixed; top: 0; right: 0; width: 50%; height: 100%;
      background: #f8f8f8; border-left: 1px solid #ccc; padding: 1rem;
      z-index: 999; overflow: auto; display: none;
    }
    .info-panel.open { display: block; }
    .info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .info-header h3 { margin: 0; }
    .info-close-btn { cursor: pointer; background: none; border: none; font-size: 1.2rem; color: #999; }
    .info-row { margin-bottom: 0.6rem; line-height: 1.4; }
    .info-label { font-weight: bold; color: #555; margin-right: 0.2rem; }
    /* ê·¸ë¦¬ë“œ í…Œì´ë¸” */
    #dataGrid {
      width: 100%; border-collapse: collapse;
    }
    #dataGrid th, #dataGrid td {
      border: 1px solid #ccc; padding: 5px; text-align: left; font-size: 14px;
    }
    #dataGrid th { background: #eee; cursor: pointer; }
    .selected { background-color: #ccc !important; }
    /* ë™ì˜ìƒ ì»¨í…Œì´ë„ˆ */
    .video-container { margin-top: 0.5rem; margin-bottom: 1rem; }
    @media (max-width:768px){
      .sidebar { width:200px; transform:translateX(-200px); }
      .sidebar.open { transform:translateX(0); }
      .info-panel { width:220px; }
    }
    /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #fff; display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 10000;
    }
    #loginHeader { text-align: center; margin-bottom: 20px; }
    #loginHeader img { width: 80px; margin-bottom: 10px; }
    #loginHeader h1 { font-size: 24px; font-weight: bold; color: #3498db; margin: 0; }
    #loginForm {
      background: #fff; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center; width: 300px;
    }
    #loginForm h2 { margin-bottom: 20px; }
    #loginForm input {
      display: block; width: 100%; padding: 10px; margin-bottom: 10px; font-size: 16px;
    }
    #loginForm button {
      padding: 10px; width: 100%; background: #3498db; color: #fff;
      border: none; border-radius: 4px; font-size: 16px; cursor: pointer;
    }
    /* ë“œë¡­ë‹¤ìš´ (ë§ˆì»¤ ìƒ‰ìƒ ì„ íƒ) */
    select.color-dropdown {
      width: 80px; padding: 0 4px; font-size: 14px; text-align: center;
      cursor: pointer; border: 1px solid #ccc;
    }
    option.color-swatch { padding: 2px; }
  </style>
</head>
<body>
  <!-- ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
  <div id="loginOverlay">
    <div id="loginHeader">
      <img src="https://raw.githubusercontent.com/hyunq0812/SPS-ACCC/main/logo.png" alt="ì‚¼ì†¡ ë¡œê³ ">
      <h1>SAMSONG</h1>
    </div>
    <form id="loginForm">
      <h2>ë¡œê·¸ì¸</h2>
      <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" required>
      <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
      <button type="submit">ë¡œê·¸ì¸</button>
    </form>
  </div>
  
  <div class="wrapper">
    <!-- í—¤ë” -->
    <div class="header">
      <div class="left-menu">
        <span class="material-icons menu-icon" onclick="openSidebar()">menu</span>
        <img src="https://raw.githubusercontent.com/hyunq0812/SPS-ACCC/main/logo.png" alt="ì‚¼ì„± ë¡œê³ " class="header-logo">
        <span class="title">Home</span>
      </div>
    </div>
    <!-- ë©”ì¸ ì˜ì—­ -->
    <div class="content">
      <!-- [MAP] í˜ì´ì§€ -->
      <section id="pageMap" class="page-section">
        <h2>ë¹„ì¶©ëŒ ë°ì´í„° MAP</h2>
        <div id="map"></div>
      </section>
      <!-- [GRID] í˜ì´ì§€ -->
      <section id="pageGrid" class="page-section">
        <h2>ë¹„ì¶©ëŒ ë°ì´í„° ê´€ë¦¬ Grid</h2>
        <div id="gridPanel">
          <!-- ê²€ìƒ‰ ì˜ì—­ -->
          <div class="search-row">
            <div class="input-group">
              <label for="gridDateSearch">ë‚ ì§œ ê²€ìƒ‰:</label>
              <input type="text" id="gridDateSearch" placeholder="ì˜ˆ: 20230110" onkeydown="if(event.key==='Enter'){ updateGrid(); }" />
            </div>
            <div class="input-group">
              <label for="gridRoadSearch">ë„ë¡œëª… ê²€ìƒ‰:</label>
              <input type="text" id="gridRoadSearch" placeholder="ì˜ˆ: ì„œì´ˆêµ¬" onkeydown="if(event.key==='Enter'){ updateGrid(); }" />
            </div>
            <div class="input-group">
              <label for="globalFilter">ì‚¬ê³ ìœ í˜• ê²€ìƒ‰:</label>
              <input type="text" id="globalFilter" placeholder="ì˜ˆ: 631" onkeydown="if(event.key==='Enter'){ updateGrid(); }" />
            </div>
            <button onclick="updateGrid()">ê²€ìƒ‰</button>
            <div class="input-group">
              <label for="globalHighlightFilter">ê°•ì¡°ë§Œ ë³´ê¸°</label>
              <input type="checkbox" id="globalHighlightFilter" onchange="updateGrid()" />
            </div>
          </div>
          <!-- ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
          <div class="control-row">
            <div class="input-group">
              <label for="globalSelect">ì „ì²´ì„ íƒ</label>
              <input type="checkbox" id="globalSelect" onchange="toggleGlobalSelect(this)" style="margin-right:20px;" />
              <label for="globalDisplay">ë§ˆì»¤ í‘œì‹œ</label>
              <input type="checkbox" id="globalDisplay" onchange="applyGlobalDisplay(this)" style="margin-right:20px;" />
              <label for="globalHighlight">ë§ˆì»¤ ê°•ì¡°</label>
              <input type="checkbox" id="globalHighlight" onchange="toggleGlobalHighlight(this)" style="margin-right:20px;" />
              <label for="globalColor">ë§ˆì»¤ ìƒ‰ìƒ</label>
              <select id="globalColor" class="color-dropdown" style="margin-right:20px; background-color:#ff0000; color:#ffffff;" onchange="applyGlobalSettingsImmediately()">
                <option class="color-swatch" value="#ff0000" style="background-color:#ff0000;" selected>&nbsp;</option>
                <option class="color-swatch" value="#ff7f00" style="background-color:#ff7f00;">&nbsp;</option>
                <option class="color-swatch" value="#ffff00" style="background-color:#ffff00;">&nbsp;</option>
                <option class="color-swatch" value="#00ff00" style="background-color:#00ff00;">&nbsp;</option>
                <option class="color-swatch" value="#0000ff" style="background-color:#0000ff;">&nbsp;</option>
                <option class="color-swatch" value="#000080" style="background-color:#000080;">&nbsp;</option>
                <option class="color-swatch" value="#800080" style="background-color:#800080;">&nbsp;</option>
                <option class="color-swatch" value="#ffffff" style="background-color:#ffffff;border:1px solid #000;">&nbsp;</option>
                <option class="color-swatch" value="#000000" style="background-color:#000000;">&nbsp;</option>
              </select>
            </div>
            <div id="loadCountLabel"></div>
          </div>
        </div>
        
        <table id="dataGrid">
          <thead>
            <tr>
              <th onclick="sortGrid('date')">ë‚ ì§œ</th>
              <th onclick="sortGrid('accident')">ì‚¬ê³ ìœ í˜•</th>
              <th onclick="sortGrid('situation')">ìƒí™©</th>
              <th onclick="sortGrid('road')">ë„ë¡œëª…</th>
              <th onclick="sortGrid('video')">ì˜ìƒíŒŒì¼ëª…</th>
              <th onclick="sortGrid('lat')">ìœ„ë„</th>
              <th onclick="sortGrid('lng')">ê²½ë„</th>
              <th>ë§ˆì»¤ í‘œì‹œ</th>
              <th>ë§ˆì»¤ ìƒ‰ìƒ</th>
              <th>ë§ˆì»¤ ê°•ì¡°</th>
            </tr>
          </thead>
          <tbody id="gridBody">
            <!-- GitHub ë°ì´í„° ë¡œë“œ í›„ í‘œì‹œ -->
          </tbody>
        </table>
      </section>
    </div>
  </div>
  
  <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">Samsong</div>
      <button class="close-btn" onclick="closeSidebar()">âœ–</button>
    </div>
    <div class="menu-group">
      <div class="menu-title">Dash Board</div>
      <div class="submenu-toggle" onclick="toggleSubmenu()">
        <span><i class="material-icons">directions_car</i>ë¹„ì¶©ëŒ ë°ì´í„° ê´€ë¦¬</span>
        <span class="material-icons">expand_more</span>
      </div>
      <div class="submenu" id="bcSubmenu">
        <div class="submenu-item" onclick="onSubmenuClick('map')">
          <div class="circle"></div>ë¹„ì¶©ëŒ ë°ì´í„° MAP
        </div>
        <div class="submenu-item" onclick="onSubmenuClick('grid')">
          <div class="circle"></div>ë¹„ì¶©ëŒ ë°ì´í„° ê´€ë¦¬ Grid
        </div>
      </div>
    </div>
  </div>
  
  <!-- ìš°ì¸¡ ìƒì„¸ íŒ¨ë„ -->
  <div class="info-panel" id="infoPanel">
    <div class="info-header">
      <h3>ìƒì„¸ ì •ë³´</h3>
      <button class="info-close-btn" onclick="closeInfoPanel()">X</button>
    </div>
    <div class="info-row"><span class="info-label">ë‚ ì§œ:</span> <span id="infoDate"></span></div>
    <div class="info-row"><span class="info-label">ì‚¬ê³ ìœ í˜•:</span> <span id="infoAccident"></span></div>
    <div class="info-row"><span class="info-label">ìƒí™©:</span> <span id="infoSituation"></span></div>
    <div class="info-row"><span class="info-label">ë„ë¡œëª…:</span> <span id="infoRoad"></span></div>
    <div class="video-container" id="infoVideoContainer">
      <!-- video ìš”ì†Œ -->
    </div>
  </div>
  
<script>
    // Firebase ì´ˆê¸°í™”
    var firebaseConfig = {
        apiKey: "AIzaSyBlfuVwqrljZuY4ezuK48tF92E6Rddm_x0",
        authDomain: "spsaccc-3aecb.firebaseapp.com",
        projectId: "spsaccc-3aecb",
        storageBucket: "spsaccc-3aecb.firebasestorage.app",
        messagingSenderId: "1014353850429",
        appId: "1:1014353850429:web:84c6f2e6d005b12e33fa54",
        measurementId: "G-B3PF68YEQP"      
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();


    let showHighlightedMarkers = false; 
    let map;
    let markerCluster;
    let isMapInitialized = false;
    let uploadedCoordinates = [];
    let clusterMarkers = [];
    let markerMap = new Map();
    let currentGridData = [];
    let isDragging = false;
    let selectionAdd = true;
    let lastClickedGridIndex = null;
    const DEFAULT_CENTER = { lat: 35.8, lng: 127.7 };
    const DEFAULT_ZOOM = 7;

    // ë¡œê·¸ì¸ í¼ ì²˜ë¦¬
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      var email = document.getElementById('loginEmail').value;
      var password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(function() {
          document.getElementById('loginOverlay').style.display = 'none';
          if (!isMapInitialized) {
            initMap();
            fetchExcelFromGitHub();
          }
          onSubmenuClick('map');
        })
        .catch(function(error) {
          if (
            error.code === 'auth/invalid-login-credentials' ||
            error.code === 'auth/wrong-password' ||
            error.code === 'auth/user-not-found'
          ) {
            alert("ì´ë©”ì¼ì´ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
          } else {
            alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
          }
        });
    });

    // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€
    auth.onAuthStateChanged(function(user) {
      if (user) {
        document.getElementById('loginOverlay').style.display = 'none';
        if (!isMapInitialized) {
          initMap();
          fetchExcelFromGitHub();
        }
        onSubmenuClick('map');
      } else {
        document.getElementById('loginOverlay').style.display = 'flex';
      }
    });

    // í˜ì´ì§€ ë¡œë“œì‹œ ì´ì „ ì„¸ì…˜ í•´ì œ
    window.onload = function() {
      auth.signOut().then(() => {
        document.addEventListener('click', function(e){
          const tag = e.target.tagName.toLowerCase();
          if(tag==='select' || tag==='option') return;
          const gridPanel = document.getElementById('dataGrid');
          const globalPanel = document.getElementById('gridPanel');
          if(!gridPanel.contains(e.target) && !globalPanel.contains(e.target)){
            uploadedCoordinates.forEach(coord => coord.selected = false);
            updateGrid();
          }
        });
        document.addEventListener('mouseup', () => { isDragging = false; });
      });
    };

    // ì‚¬ì´ë“œë°”/ë©”ë‰´
    function openSidebar(){ document.getElementById('sidebar').classList.add('open'); }
    function closeSidebar(){ document.getElementById('sidebar').classList.remove('open'); }
    function toggleSubmenu(){ document.getElementById('bcSubmenu').classList.toggle('open'); }

    function onSubmenuClick(page){
      closeSidebar();
      if(page !== 'map') closeInfoPanel();
      document.querySelectorAll('.submenu-item').forEach(i => i.classList.remove('active'));
      const items = document.querySelectorAll('.submenu-item');
      if(page === 'map') items[0].classList.add('active');
      else if(page === 'grid') items[1].classList.add('active');
      document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
      if(page === 'map'){
        document.getElementById('pageMap').classList.add('active');
        refreshMarkers();
      } else {
        document.getElementById('pageGrid').classList.add('active');
        updateGrid();
      }
    }
    function openInfoPanel(){ document.getElementById('infoPanel').classList.add('open'); }
    function closeInfoPanel(){ document.getElementById('infoPanel').classList.remove('open'); }

    // ì—‘ì…€ ë¡œë“œ
    async function fetchExcelFromGitHub(){
      try {
        const url = "https://raw.githubusercontent.com/hyunq0812/SPS-ACCC/main/tesla_data.xlsx"
        const response = await fetch(url);
        if(!response.ok) throw new Error("Network response was not ok: " + response.status);
        const arrayBuffer = await response.arrayBuffer();
        const wb = XLSX.read(arrayBuffer, {type:'array'});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1});
        uploadedCoordinates = [];
        for(let i=5; i<rows.length; i++){
          const row = rows[i];
          if(!row) continue;
          let valA = String(row[0]??"").trim();
          let valB = String(row[1]??"").trim();
          if(!valA || !valB) continue;
          const lat = parseFloat(row[12]??"");
          const lng = parseFloat(row[13]??"");
          if(isNaN(lat) || isNaN(lng)) continue;
          let rawDate = String(row[3]??"").trim();
          let dateOnly = (rawDate.length>=10)?rawDate.substring(0,10):rawDate;
          let accident = String(row[17]??"").trim();
          let situation = String(row[15]??"").trim();
          let road = String(row[35]??"").trim();
          let videoFile = String(row[2]??"").trim();
          uploadedCoordinates.push({
            lat, lng,
            date: dateOnly,
            accident,
            situation,
            road,
            video: videoFile,
            display: true,
            markerColor: "#ff0000",
            selected: false,
            highlight: false
          });
// Firebase ì˜ìƒ ë§í¬ ìƒì„±
let videoURL = `https://firebasestorage.googleapis.com/v0/b/spsaccc-3aecb.appspot.com/o/video_tesla%2F${encodeURIComponent(videoFile)}?alt=media`;

// InfoWindowì— í‘œì‹œí•  ë‚´ìš© ì €ì¥ (í•„ìš” ì‹œ ê°ì²´ì— ë„£ê±°ë‚˜ ë‚˜ì¤‘ì— ì‚¬ìš©)
let infoContent = `
  <div><strong>${dateOnly}</strong></div>
  <div>ì‚¬ê³ ìœ í˜•: ${accident}</div>
  <div>ìƒí™©: ${situation}</div>
  <div>ë„ë¡œ: ${road}</div>
  ${videoFile ? `<video src="${videoURL}" width="300" controls></video>` : `<div>ğŸ“ ì˜ìƒ ì—†ìŒ</div>`}
`;

// ì˜ˆ: uploadedCoordinatesì— í•¨ê»˜ ì €ì¥í•˜ê±°ë‚˜, ë§ˆì»¤ ìƒì„±í•  ë•Œ ì‚¬ìš©
uploadedCoordinates[uploadedCoordinates.length - 1].infoContent = infoContent;

        }
        document.getElementById('loadCountLabel').textContent = uploadedCoordinates.length + "ê°œ ë¡œë“œë¨";
        updateGrid();
        refreshMarkers();
      } catch(err){
        console.error("GitHub Excel ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
        alert("ì—‘ì…€ ë¡œë“œ ì˜¤ë¥˜: " + err.message);
      }
    }

    // ìƒì„¸ì •ë³´ íŒ¨ë„
    function updateInfoPanel(coord){
      document.getElementById('infoDate').textContent = coord.date || "";
      document.getElementById('infoAccident').textContent = coord.accident || "";
      document.getElementById('infoSituation').textContent = coord.situation || "";
      document.getElementById('infoRoad').textContent = coord.road || "";
      const videoContainer = document.getElementById('infoVideoContainer');
      videoContainer.innerHTML = "";
      let videoFileName = coord.video;
      if(videoFileName){
        videoFileName = videoFileName.split(/[/\\]/).pop().trim();
        if(!videoFileName.toLowerCase().endsWith(".mp4")) {
          videoFileName += ".mp4";
        }
      }
      if(videoFileName){
const rawUrl = "https://firebasestorage.googleapis.com/v0/b/spsaccc-3aecb.appspot.com/o/video_tesla%2F" + encodeURIComponent(videoFileName) + "?alt=media";
        const videoElem = document.createElement("video");
        videoElem.controls = true;
        videoElem.autoplay = true;
        videoElem.style.width = "100%";
        videoElem.style.height = "300px";
        const source = document.createElement("source");
        source.src = rawUrl;
        source.type = "video/mp4";
        videoElem.appendChild(source);
        videoContainer.appendChild(videoElem);
      } else {
        videoContainer.textContent = "ë™ì˜ìƒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.";
      }
    }

    // ì§€ë„ ì´ˆê¸°í™”
    function initMap(){
      if(isMapInitialized) return;
      isMapInitialized = true;
      map = new google.maps.Map(document.getElementById('map'), {
        center: DEFAULT_CENTER,
        zoom: DEFAULT_ZOOM,
        mapTypeId: 'roadmap'
      });
      markerCluster = new markerClusterer.MarkerClusterer({ map, markers: [] });
      // ê°•ì¡° ë§ˆì»¤ ë³´ê¸° í† ê¸€ ë²„íŠ¼
      const toggleDiv = document.createElement('div');
      createToggleControl(toggleDiv);
      map.controls[google.maps.ControlPosition.TOP_RIGHT].push(toggleDiv);
      // ì§€ë„ ì´ˆê¸°í™” ë²„íŠ¼
      const resetDiv = document.createElement('div');
      createResetControl(resetDiv);
      map.controls[google.maps.ControlPosition.LEFT_TOP].push(resetDiv);
    }
    function createResetControl(controlDiv){
      controlDiv.style.backgroundColor = '#fff';
      controlDiv.style.border = '2px solid #fff';
      controlDiv.style.borderRadius = '3px';
      controlDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
      controlDiv.style.cursor = 'pointer';
      controlDiv.style.marginTop = '10px';
      controlDiv.style.marginLeft = '10px';
      controlDiv.style.textAlign = 'center';
      controlDiv.title = 'í´ë¦­í•˜ì—¬ ì§€ë„ ì´ˆê¸°í™”';
      const controlText = document.createElement('div');
      controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
      controlText.style.fontSize = '16px';
      controlText.style.padding = '8px';
      controlText.innerHTML = 'ì´ˆê¸°í™”';
      controlDiv.appendChild(controlText);
      controlDiv.addEventListener('click', () => {
        map.setCenter(DEFAULT_CENTER);
        map.setZoom(DEFAULT_ZOOM);
      });
    }
    function createToggleControl(controlDiv){
      controlDiv.style.backgroundColor = '#fff';
      controlDiv.style.border = '2px solid #fff';
      controlDiv.style.borderRadius = '3px';
      controlDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
      controlDiv.style.cursor = 'pointer';
      controlDiv.style.marginTop = '10px';
      controlDiv.style.marginRight = '10px';
      controlDiv.style.textAlign = 'center';
      controlDiv.title = 'í´ë¦­í•˜ì—¬ ê°•ì¡° ë§ˆì»¤ë§Œ ë³´ê¸° í† ê¸€';
      const controlText = document.createElement('div');
      controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
      controlText.style.fontSize = '16px';
      controlText.style.padding = '8px';
      controlText.innerHTML = 'ê°•ì¡° ë§ˆì»¤ë§Œ ë³´ê¸°: OFF';
      controlDiv.appendChild(controlText);
      controlDiv.addEventListener('click', () => {
        showHighlightedMarkers = !showHighlightedMarkers;
        controlText.innerHTML = 'ê°•ì¡° ë§ˆì»¤ë§Œ ë³´ê¸°: ' + (showHighlightedMarkers ? 'ON' : 'OFF');
        refreshMarkers();
      });
    }

    // ì¼ë°˜ ë§ˆì»¤
    function createMarkerIcon(color, text){
      let textColor = "#ffffff";
      if(color.toLowerCase() === "#ffffff" || color.toLowerCase() === "#ffff00") {
        textColor = "#000000";
      }
      const svg = `
        <svg width="40" height="40" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
          <!-- ì›ì„ ë·°ë°•ìŠ¤ ì¤‘ì•™(25,25)ì— radius=20ìœ¼ë¡œ -->
          <circle cx="25" cy="25" r="20" fill="${color}" />
          <text x="25" y="31" text-anchor="middle" fill="${textColor}" font-size="16" font-family="Roboto" font-weight="bold">${text}</text>
        </svg>
      `;
      return {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
        // ìµœì¢… ë Œë” í¬ê¸°ëŠ” 40Ã—40
        scaledSize: new google.maps.Size(40, 40)
      };
    }

    // ê°•ì¡° ë§ˆì»¤: viewBox="0 0 50 50"ë¡œ í™•ëŒ€, í…Œë‘ë¦¬+ë³„ë„ ì•ˆ ì˜ë¦¬ê²Œ
    function createHighlightedIcon(color, text){
      let textColor = "#ffffff";
      if(color.toLowerCase() === "#ffffff" || color.toLowerCase() === "#ffff00") {
        textColor = "#000000";
      }
      let borderColor = "#000000";
      if(color.toLowerCase() === "#000000") {
        borderColor = "#ffffff";
      }
      // ë³„ ì¤‘ì‹¬ê³¼ ë°˜ì§€ë¦„, strokeWidth
      // ì—¬ê¸°ì„œ ë³„ ì¤‘ì‹¬ (starCx, starCy)ì„ 10,10 ë“±ìœ¼ë¡œ ì¡ì•„ë„ ë˜ê³ 
      // ì›ì˜ ì¤‘ì‹¬ì€ (25,25)ì— radius=20
      const starCx = 10;
      const starCy = 10;
      const outerR = 8;
      const innerR = 4;
      const starStrokeWidth = 3;
      
      // 5ê°ë³„ ì  ê³„ì‚°
      let starPoints = "";
      for (let i = 0; i < 10; i++) {
        let angleDeg = -90 + i * 36; 
        let angleRad = angleDeg * Math.PI / 180;
        let r = (i % 2 === 0) ? outerR : innerR;
        let x = starCx + r * Math.cos(angleRad);
        let y = starCy + r * Math.sin(angleRad);
        starPoints += `${x},${y} `;
      }
      
      const svg = `
        <svg width="40" height="40" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
          <!-- ì›(ì‚¬ìš©ì ìƒ‰), ì¤‘ì‹¬ (25,25), ë°˜ì§€ë¦„=20, í…Œë‘ë¦¬=2px -->
          <circle cx="25" cy="25" r="20" fill="${color}" stroke="${borderColor}" stroke-width="2"/>
          <!-- ë…¸ë€ ë³„ (ì¢Œí‘œ starCx=10, starCy=10), strokeWidth=2.5 -->
          <polygon fill="yellow" stroke="black" stroke-width="${starStrokeWidth}" points="${starPoints}" />
          <!-- í…ìŠ¤íŠ¸ -->
          <text x="25" y="31" text-anchor="middle" fill="${textColor}" font-size="16" font-family="Roboto" font-weight="bold">${text}</text>
        </svg>
      `;
      return {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
        scaledSize: new google.maps.Size(40, 40)
      };
    }

    // ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
    function updateGrid(){
      const gridBody = document.getElementById('gridBody');
      gridBody.innerHTML = "";
      const filterValue = document.getElementById('globalFilter').value.trim();
      const gridDate = document.getElementById('gridDateSearch').value.trim();
      const gridRoad = document.getElementById('gridRoadSearch').value.trim();
      const highlightOnly = document.getElementById('globalHighlightFilter').checked;
      
      let dataToShow = uploadedCoordinates;
      if(filterValue) {
        dataToShow = dataToShow.filter(coord => coord.accident.includes(filterValue));
      }
      if(gridDate) {
        const searchDate = gridDate.replace(/-/g, '');
        dataToShow = dataToShow.filter(coord => coord.date.replace(/-/g, '').includes(searchDate));
      }
      if(gridRoad) {
        dataToShow = dataToShow.filter(coord => coord.road.includes(gridRoad));
      }
      if(highlightOnly) {
        dataToShow = dataToShow.filter(coord => coord.highlight);
      }
      currentGridData = dataToShow;

      dataToShow.forEach((coord, gridIndex) => {
        const origIndex = uploadedCoordinates.indexOf(coord);
        const tr = document.createElement("tr");
        tr.dataset.origIndex = origIndex;
        tr.dataset.gridIndex = gridIndex;
        if(coord.selected) tr.classList.add("selected");

        const colorOptions = [
          "#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#000080","#800080","#ffffff","#000000"
        ];
        
        let colorSelectHtml = `<select onchange="setMarkerColor(${origIndex}, this)" class="color-dropdown" id="colorSelect_${origIndex}">`;
        colorOptions.forEach(col => {
          let styleText = `background-color:${col};`;
          if(col.toLowerCase() === "#ffffff") styleText += "border:1px solid #000;";
          let selectedAttr = (coord.markerColor.toLowerCase() === col.toLowerCase()) ? 'selected' : '';
          colorSelectHtml += `<option class="color-swatch" value="${col}" style="${styleText}" ${selectedAttr}>&nbsp;</option>`;
        });
        colorSelectHtml += `</select>`;
        
        tr.innerHTML = `
          <td>${coord.date}</td>
          <td>${coord.accident}</td>
          <td>${coord.situation}</td>
          <td>${coord.road}</td>
          <td>${coord.video}</td>
          <td>${coord.lat}</td>
          <td>${coord.lng}</td>
          <td><input type="checkbox" onchange="toggleDisplay(${origIndex}, this)" ${coord.display ? "checked" : ""}></td>
          <td>${colorSelectHtml}</td>
          <td><input type="checkbox" onchange="toggleHighlight(${origIndex}, this)" ${coord.highlight ? "checked" : ""}></td>
        `;
        
        tr.addEventListener('mousedown', function(e) {
          const tag = e.target.tagName.toLowerCase();
          if(tag==='select' || tag==='option') return;
          e.preventDefault();
          isDragging = true;
          if(e.ctrlKey || e.metaKey) {
            selectionAdd = !uploadedCoordinates[origIndex].selected;
            uploadedCoordinates[origIndex].selected = selectionAdd;
          } else if(e.shiftKey && lastClickedGridIndex !== null) {
            return;
          } else {
            uploadedCoordinates.forEach(c => c.selected = false);
            document.querySelectorAll('#gridBody tr').forEach(row => row.classList.remove('selected'));
            uploadedCoordinates[origIndex].selected = true;
            selectionAdd = true;
          }
          tr.classList.toggle('selected', uploadedCoordinates[origIndex].selected);
          lastClickedGridIndex = gridIndex;
        });
        tr.addEventListener('mouseenter', function(e) {
          if(isDragging) {
            uploadedCoordinates[origIndex].selected = selectionAdd;
            tr.classList.toggle('selected', selectionAdd);
          }
        });
        tr.addEventListener('mouseup', function() { isDragging = false; });
        tr.addEventListener('click', function(e) {
          const tag = e.target.tagName.toLowerCase();
          if(tag==='select' || tag==='option') return;
          if(e.shiftKey && lastClickedGridIndex !== null) {
            let currentGridRows = Array.from(document.querySelectorAll('#gridBody tr'));
            let currentIndex = gridIndex;
            let start = Math.min(lastClickedGridIndex, currentIndex);
            let end = Math.max(lastClickedGridIndex, currentIndex);
            currentGridRows.forEach((row, idx) => {
              if(idx >= start && idx <= end) {
                let origIdx = parseInt(row.dataset.origIndex);
                uploadedCoordinates[origIdx].selected = true;
                row.classList.add('selected');
              }
            });
          }
        });
        
        gridBody.appendChild(tr);

        const colorSelect = tr.querySelector(`#colorSelect_${origIndex}`);
        applySelectBackgroundColor(colorSelect, coord.markerColor);
      });
    }

    function applySelectBackgroundColor(selectElem, colorValue){
      selectElem.style.backgroundColor = colorValue;
      if(colorValue.toLowerCase() === "#ffffff" || colorValue.toLowerCase() === "#ffff00"){
        selectElem.style.color = "#000000";
      } else {
        selectElem.style.color = "#ffffff";
      }
    }

    // ê°œë³„ ë§ˆì»¤ ì„¤ì •
    function toggleDisplay(index, checkbox) {
      uploadedCoordinates[index].display = checkbox.checked;
      refreshMarkers();
    }
    function setMarkerColor(index, selectElem) {
      uploadedCoordinates[index].markerColor = selectElem.value;
      applySelectBackgroundColor(selectElem, selectElem.value);
      refreshMarkers();
    }
    function toggleHighlight(index, checkbox) {
      uploadedCoordinates[index].highlight = checkbox.checked;
      refreshMarkers();
    }

    // ì „ì—­ ì¦‰ì‹œ ë°˜ì˜
    function applyGlobalSettingsImmediately(){
      const globalColorSelect = document.getElementById('globalColor');
      const globalColor = globalColorSelect.value;
      applySelectBackgroundColor(globalColorSelect, globalColor);
      const filterValue = document.getElementById('globalFilter').value.trim();
      let dataToShow = filterValue
        ? uploadedCoordinates.filter(coord => coord.accident.includes(filterValue))
        : uploadedCoordinates;
      dataToShow.forEach(coord => {
        if(coord.selected) coord.markerColor = globalColor;
      });
      updateGrid();
      refreshMarkers();
    }
    function toggleGlobalHighlight(checkbox) {
      uploadedCoordinates.forEach(coord => {
        if(coord.selected) coord.highlight = checkbox.checked;
      });
      updateGrid();
      refreshMarkers();
    }
    function toggleGlobalSelect(checkbox) {
      const filterValue = document.getElementById('globalFilter').value.trim();
      let dataToShow = filterValue
        ? uploadedCoordinates.filter(coord => coord.accident.includes(filterValue))
        : uploadedCoordinates;
      dataToShow.forEach(coord => { coord.selected = checkbox.checked; });
      updateGrid();
    }
    function applyGlobalDisplay(checkbox) {
      uploadedCoordinates.forEach(coord => {
        if(coord.selected) coord.display = checkbox.checked;
      });
      updateGrid();
      refreshMarkers();
    }

    // ì •ë ¬
    function sortGrid(key) {
      uploadedCoordinates.sort((a, b) => {
        if(a[key] < b[key]) return -1;
        if(a[key] > b[key]) return 1;
        return 0;
      });
      updateGrid();
    }
    function filterGrid(){ updateGrid(); }

    // ë§ˆì»¤ ê°±ì‹ 
    function refreshMarkers() {
      if(!isMapInitialized) return;
      clusterMarkers.forEach(m => m.setMap(null));
      clusterMarkers = [];
      markerCluster.clearMarkers();
      uploadedCoordinates.forEach(coord => {
        if(!coord.display) return;
        if(showHighlightedMarkers && !coord.highlight) return;
        
        let icon = coord.highlight 
          ? createHighlightedIcon(coord.markerColor, coord.accident)
          : createMarkerIcon(coord.markerColor, coord.accident);
        
        let marker = markerMap.get(coord);
        if(!marker) {
          marker = new google.maps.Marker({ position: {lat: coord.lat, lng: coord.lng} });
          markerMap.set(coord, marker);
          marker.addListener('click', () => {
            updateInfoPanel(coord);
            openInfoPanel();
            if(coord.highlight) {
              map.setZoom(15);
              map.panTo({lat: coord.lat, lng: coord.lng});
            }
          });
        }
        marker.setIcon(icon);
        marker.setMap(null);
        clusterMarkers.push(marker);
      });
      markerCluster.addMarkers(clusterMarkers);
    }
  </script>
</body>
</html>
