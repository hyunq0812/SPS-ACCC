<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ACCC CSV Full Version</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB86fhLyjTezPAfXW6Y1qPAZkDeyfoTmk8" async defer></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js" async defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>body {margin:0;padding:0;} #map {width:100%; height:100vh;}
  #loginOverlay {position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;
  display:flex;flex-direction:column;align-items:center;justify-content:center;}
  #infoPanel {position:fixed;top:0;right:0;width:400px;height:100%;background:#f8f8f8;
  border-left:1px solid #ccc;padding:1rem;overflow:auto;display:none;}
  </style>
</head>
<body>
<div id="loginOverlay">
  <h1>로그인</h1>
  <input id="email" placeholder="이메일"><br>
  <input id="password" type="password" placeholder="비밀번호"><br>
  <button onclick="login()">로그인</button>
</div>
<div id="map"></div>
<div id="infoPanel">
  <h3>상세 정보</h3>
  날짜: <span id="infoDate"></span><br>
  사고유형: <span id="infoAccident"></span><br>
  상황: <span id="infoSituation"></span><br>
  도로명: <span id="infoRoad"></span><br>
  <div id="infoVideo"></div>
  <button onclick="document.getElementById('infoPanel').style.display='none'">닫기</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBlfuVwqrljZuY4ezuK48tF92E6Rddm_x0",
  authDomain: "spsaccc-3aecb.firebaseapp.com",
  projectId: "spsaccc-3aecb",
  storageBucket: "spsaccc-3aecb.appspot.com",
  messagingSenderId: "1014353850429",
  appId: "1:1014353850429:web:84c6f2e6d005b12e33fa54"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

let uploadedCoordinates = [];

auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById("loginOverlay").style.display = "none";
    init();
  }
});

function login() {
  const email = document.getElementById("email").value;
  const pw = document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email, pw).catch(e => alert(e.message));
}

async function init() {
  const map = new google.maps.Map(document.getElementById("map"), {center: {lat:35.8, lng:127.7}, zoom:7});

  const res = await fetch("https://raw.githubusercontent.com/hyunq0812/SPS-ACCC/main/tesla_data.csv");
  let csvText = await res.text();
  if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.slice(1);
  const rows = csvText.split('\n').map(line => line.split(','));

  const markers = [];
  for (let i=5; i<rows.length; i++) {
    const row = rows[i];
    if (!row || row.length<36) continue;
    let lat = parseFloat(row[12] ?? "");
    let lng = parseFloat(row[13] ?? "");
    if (!lat || !lng) continue;
    let coord = {
      lat: lat,
      lng: lng,
      date: row[3] ?? "",
      accident: row[17] ?? "",
      situation: row[15] ?? "",
      road: row[35] ?? "",
      video: row[2] ?? ""
    };
    uploadedCoordinates.push(coord);

    const marker = new google.maps.Marker({position: {lat, lng}, map: map});
    marker.addListener('click', () => {
      updateInfoPanel(coord);
    });
    markers.push(marker);
  }
  new markerClusterer.MarkerClusterer({ map, markers });
}

function updateInfoPanel(coord) {
  document.getElementById("infoDate").textContent = coord.date;
  document.getElementById("infoAccident").textContent = coord.accident;
  document.getElementById("infoSituation").textContent = coord.situation;
  document.getElementById("infoRoad").textContent = coord.road;

  let videoDiv = document.getElementById("infoVideo");
  videoDiv.innerHTML = "";
  let videoFile = coord.video.trim();
  if(videoFile){
    if(!videoFile.toLowerCase().endsWith(".mp4")) videoFile += ".mp4";
    const videoUrl = "https://github.com/hyunq0812/SPS-ACCC/raw/main/Video/" + videoFile;
    videoDiv.innerHTML = `<video width="100%" height="300" controls autoplay><source src="${videoUrl}" type="video/mp4"></video>`;
  } else {
    videoDiv.innerHTML = "동영상 파일이 없습니다.";
  }
  document.getElementById("infoPanel").style.display = "block";
}
</script>
</body>
</html>
