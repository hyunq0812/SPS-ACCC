<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>비충돌 데이터 MAP</title>
  <!-- 구글 폰트/아이콘 -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Google Maps + MarkerCluster -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8UBtKnkeivt08HnA9nRuqQZ6QIYTVSZ0" async defer></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js" async></script>

  <style>
    /* 기본 리셋 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: #f5f5f5;
      overflow: hidden;
    }
    .wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }
    /* 헤더(상단) */
    .header {
      height: 60px;
      background: #fff;
      display: flex;
      align-items: center;
      padding: 0 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .header .left-menu {
      display: flex;
      align-items: center;
    }
    .menu-icon {
      cursor: pointer;
      margin-right: 1rem;
    }
    /* 헤더 로고: ./logo.png 사용, 크기를 80px로 확대, alt 속성 제거 */
    .header-logo {
      width: 80px;
      height: 80px;
      margin-right: 1rem;
    }
    .title {
      font-size: 1.2rem;
      font-weight: 500;
    }
    /* 메인 영역 */
    .content {
      flex: 1;
      overflow: auto;
      background: #fff;
      padding: 1rem;
    }
    .page-section {
      display: none;
    }
    .page-section.active {
      display: block;
    }
    /* 지도/위성 토글 */
    .map-toggle {
      margin-bottom: 0.5rem;
    }
    .map-toggle button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 0.4rem 0.7rem;
      margin-right: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .map-toggle button:hover {
      background: #2980b9;
    }
    /* 지도 */
    #map {
      width: 100%;
      height: 500px;
      background: #ddd;
    }
    /* 좌측 사이드바 */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100%;
      background: #2c3e50;
      color: #ecf0f1;
      transform: translateX(-260px);
      transition: transform 0.3s ease;
      z-index: 999;
      display: flex;
      flex-direction: column;
    }
    .sidebar.open {
      transform: translateX(0);
    }
    .sidebar-header {
      background: #34495e;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-header .logo {
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    /* 좌측 사이드바 로고 이미지 제거 */
    .sidebar-header .logo img {
      display: none;
    }
    .close-btn {
      cursor: pointer;
      font-size: 1.4rem;
      color: #ecf0f1;
      background: none;
      border: none;
    }
    .menu-group {
      padding: 1rem;
    }
    .menu-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 0.3rem;
      opacity: 0.7;
    }
    .submenu-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.5rem;
      cursor: pointer;
      margin-top: 0.5rem;
      border-radius: 4px;
      background: #3b4a58;
      transition: background 0.2s;
    }
    .submenu-toggle:hover {
      background: #4a5966;
    }
    .submenu-toggle span {
      display: flex;
      align-items: center;
    }
    .submenu-toggle i {
      margin-right: 0.3rem;
    }
    .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      margin-left: 0.5rem;
    }
    .submenu.open {
      max-height: 200px;
    }
    .submenu-item {
      padding: 0.3rem 1rem;
      display: flex;
      align-items: center;
      cursor: pointer;
      border-radius: 4px;
      margin: 0.2rem 0;
      transition: background 0.2s;
    }
    .submenu-item:hover {
      background: #4a5966;
    }
    .submenu-item .circle {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #ecf0f1;
      margin-right: 0.5rem;
    }
    .submenu-item.active .circle {
      background: #ecf0f1;
    }
    /* 우측 상세 패널 (마커 클릭 시) */
    .info-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background: #f8f8f8;
      border-left: 1px solid #ccc;
      padding: 1rem;
      z-index: 999;
      overflow: auto;
      display: none;
    }
    .info-panel.open {
      display: block;
    }
    .info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .info-header h3 {
      margin: 0;
    }
    .info-close-btn {
      cursor: pointer;
      background: none;
      border: none;
      font-size: 1.2rem;
      color: #999;
    }
    .info-row {
      margin-bottom: 0.6rem;
      line-height: 1.4;
    }
    .info-label {
      font-weight: bold;
      color: #555;
      margin-right: 0.2rem;
    }
    /* 동영상 재생 컨테이너 */
    .video-container {
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }
    @media (max-width:768px){
      .sidebar {
        width:200px; transform:translateX(-200px);
      }
      .sidebar.open {
        transform:translateX(0);
      }
      .info-panel {
        width:220px;
      }
    }
  </style>
</head>
<body>

<div class="wrapper">
  <!-- 헤더 -->
  <div class="header">
    <div class="left-menu">
      <span class="material-icons menu-icon" onclick="openSidebar()">menu</span>
      <!-- 헤더 로고: ./logo.png 사용, alt 속성 제거, 크기는 80px -->
      <img src="./logo.png" class="header-logo" />
      <span class="title">Home</span>
    </div>
  </div>

  <!-- 메인 영역 -->
  <div class="content">
    <!-- [MAP] -->
    <section id="pageMap" class="page-section active">
      <h2>비충돌 데이터 MAP</h2>
      <h3>비충돌 데이터 MAP</h3>
      <div class="map-toggle">
        <button onclick="setMapType('roadmap')">지도</button>
        <button onclick="setMapType('satellite')">위성</button>
      </div>
      <div id="map"></div>
    </section>

    <!-- [GRID] -->
    <section id="pageGrid" class="page-section">
      <h2>비충돌 데이터 관리 Grid</h2>
      <p>Grid(표) 기능</p>
    </section>

    <!-- [업/수정] -->
    <section id="pageUpload" class="page-section">
      <h2>비충돌 데이터 관리 업/수정</h2>
      <p>폴더 선택(webkitdirectory) → 동영상 파일들 로드</p>
      <div>
        <label>동영상 폴더:</label>
        <input type="file" webkitdirectory multiple id="videoFolder" />
        <button onclick="saveVideoFolder()">저장</button>
      </div>
    </section>

    <!-- [EXCEL 입력] -->
    <section id="pageExcel" class="page-section">
      <h2>비충돌 데이터 Excel 입력</h2>
      <p>
        6행부터 / A=0, B=1 공란 skip / <b>C=2=동영상파일명</b><br/>
        M=12=위도, N=13=경도, D=3=날짜(앞10), S=18=사고유형, P=15=상황, AK=36=도로명
      </p>
      <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="onExcelChange(event)" />
    </section>
  </div>
</div>

<!-- 좌측 사이드바 -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <!-- 좌측 사이드바 로고 제거: 로고 이미지 태그 삭제 -->
      Samsong
    </div>
    <button class="close-btn" onclick="closeSidebar()">✖</button>
  </div>
  <div class="menu-group">
    <div class="menu-title">Dash Board</div>
    <div class="submenu-toggle" onclick="toggleSubmenu()">
      <span>
        <i class="material-icons">directions_car</i>
        비충돌 데이터 관리
      </span>
      <span class="material-icons">expand_more</span>
    </div>
    <div class="submenu" id="bcSubmenu">
      <div class="submenu-item" onclick="onSubmenuClick('map')">
        <div class="circle"></div>
        비충돌 데이터 MAP
      </div>
      <div class="submenu-item" onclick="onSubmenuClick('grid')">
        <div class="circle"></div>
        비충돌 데이터 관리 Grid
      </div>
      <div class="submenu-item" onclick="onSubmenuClick('upload')">
        <div class="circle"></div>
        비충돌 데이터 관리 업/수정
      </div>
      <div class="submenu-item" onclick="onSubmenuClick('excel')">
        <div class="circle"></div>
        비충돌 데이터 Excel 입력
      </div>
    </div>
  </div>
</div>

<!-- 우측 상세 패널 -->
<div class="info-panel" id="infoPanel">
  <div class="info-header">
    <h3>상세 정보</h3>
    <button class="info-close-btn" onclick="closeInfoPanel()">X</button>
  </div>
  <div class="info-row">
    <span class="info-label">날짜:</span> <span id="infoDate"></span>
  </div>
  <div class="info-row">
    <span class="info-label">사고유형:</span> <span id="infoAccident"></span>
  </div>
  <div class="info-row">
    <span class="info-label">상황:</span> <span id="infoSituation"></span>
  </div>
  <div class="info-row">
    <span class="info-label">도로명:</span> <span id="infoRoad"></span>
  </div>
  <!-- 우측 상세 패널 내 동영상 재생 컨테이너 (동영상 있으면 바로 재생) -->
  <div class="video-container" id="infoVideoContainer">
    <!-- video 요소가 생성되어 바로 재생됩니다. -->
  </div>
</div>

<script>
  let map;
  let markerCluster;
  let isMapInitialized = false;

  // 업로드된 데이터: { lat, lng, date, accident, situation, road, video }
  let uploadedCoordinates = [];
  let markers = [];

  // 동영상 파일들을 저장할 객체 (파일명 → File 객체)
  let videoFiles = {};

  function openSidebar(){
    document.getElementById('sidebar').classList.add('open');
  }
  function closeSidebar(){
    document.getElementById('sidebar').classList.remove('open');
  }
  function toggleSubmenu(){
    document.getElementById('bcSubmenu').classList.toggle('open');
  }
  function onSubmenuClick(page){
    closeSidebar();
    document.querySelectorAll('.submenu-item').forEach(i => i.classList.remove('active'));
    const items = document.querySelectorAll('.submenu-item');
    switch(page){
      case 'map': items[0].classList.add('active'); break;
      case 'grid': items[1].classList.add('active'); break;
      case 'upload': items[2].classList.add('active'); break;
      case 'excel': items[3].classList.add('active'); break;
    }
    document.querySelectorAll('.page-section').forEach(sec => sec.classList.remove('active'));
    if(page === 'map'){
      document.getElementById('pageMap').classList.add('active');
      refreshMarkers();
    } else if(page === 'grid'){
      document.getElementById('pageGrid').classList.add('active');
    } else if(page === 'upload'){
      document.getElementById('pageUpload').classList.add('active');
    } else if(page === 'excel'){
      document.getElementById('pageExcel').classList.add('active');
    }
  }

  // 상세 패널 열/닫
  function openInfoPanel(){
    document.getElementById('infoPanel').classList.add('open');
  }
  function closeInfoPanel(){
    document.getElementById('infoPanel').classList.remove('open');
  }
  function updateInfoPanel(coord){
    document.getElementById('infoDate').textContent = coord.date || "";
    document.getElementById('infoAccident').textContent = coord.accident || "";
    document.getElementById('infoSituation').textContent = coord.situation || "";
    document.getElementById('infoRoad').textContent = coord.road || "";
    
    const videoContainer = document.getElementById('infoVideoContainer');
    videoContainer.innerHTML = "";
    
    // Excel의 C열에 기록된 동영상 파일명(경로 포함 가능)에서 파일명만 추출하고 소문자, trim() 적용
    let videoFileName = coord.video;
    if (videoFileName) {
      videoFileName = videoFileName.split(/[/\\]/).pop().trim().toLowerCase();
    }
    console.log("요청한 동영상 파일명:", videoFileName);
    console.log("videoFiles 객체:", videoFiles);
    
    // 정확한 키가 없으면, videoFiles의 키 중 videoFileName으로 시작하는 항목을 찾음
    if (videoFileName && !videoFiles[videoFileName]) {
      for (let key in videoFiles) {
        if (key.startsWith(videoFileName)) {
          videoFileName = key;
          break;
        }
      }
    }
    
    if (videoFileName && videoFiles[videoFileName]) {
      const url = URL.createObjectURL(videoFiles[videoFileName]);
      const videoElem = document.createElement("video");
      videoElem.controls = true;
      videoElem.autoplay = true;
      videoElem.src = url;
      videoElem.style.width = "100%";
      videoElem.style.maxWidth = "250px";
      videoElem.style.height = "150px";
      videoContainer.appendChild(videoElem);
    } else {
      videoContainer.textContent = "동영상 파일이 없습니다.";
    }
  }

  // 지도 초기화
  function initMap(){
    if(isMapInitialized) return;
    isMapInitialized = true;
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 35.8, lng: 127.7},
      zoom: 7,
      mapTypeId: 'roadmap'
    });
    markerCluster = new markerClusterer.MarkerClusterer({ map, markers: [] });
  }
  function setMapType(type){
    if(!isMapInitialized) return;
    map.setMapTypeId(type);
  }

  // 동영상 폴더 선택 시, 파일명을 소문자와 trim() 처리하여 videoFiles 객체에 저장
  function saveVideoFolder(){
    const input = document.getElementById('videoFolder');
    if(!input.files.length){
      alert("폴더가 선택되지 않았습니다.");
      return;
    }
    videoFiles = {};
    for (let i = 0; i < input.files.length; i++){
      const file = input.files[i];
      const key = file.name.trim().toLowerCase();
      videoFiles[key] = file;
    }
    console.log("동영상 폴더에서 로드된 파일들:", videoFiles);
    alert("동영상 폴더에서 " + input.files.length + "개의 파일 로드됨.");
  }

  // 엑셀 업로드
  function onExcelChange(e){
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(evt){
      try{
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1});
        
        uploadedCoordinates = [];
        for(let i = 5; i < rows.length; i++){
          const row = rows[i];
          if(!row) continue;
          
          let valA = String(row[0] ?? "").trim();
          let valB = String(row[1] ?? "").trim();
          if(!valA || !valB) continue;
          
          const lat = parseFloat(row[12] ?? "");
          const lng = parseFloat(row[13] ?? "");
          if(isNaN(lat) || isNaN(lng)) continue;
          
          let rawDate = String(row[3] ?? "").trim();
          let dateOnly = (rawDate.length >= 10) ? rawDate.substring(0, 10) : rawDate;
          
          let accident = String(row[18] ?? "").trim();
          let situation = String(row[15] ?? "").trim();
          let road = String(row[36] ?? "").trim();
          let videoFile = String(row[2] ?? "").trim();
          
          uploadedCoordinates.push({
            lat, lng,
            date: dateOnly,
            accident,
            situation,
            road,
            video: videoFile
          });
        }
        alert(uploadedCoordinates.length + "개 좌표 로드됨(엑셀)");
      } catch(err){
        console.error("XLSX parse error:", err);
        alert("엑셀 파싱 오류: " + err.message);
      }
    };
    reader.onerror = function(err){
      console.error("FileReader error:", err);
      alert("파일 읽기 실패: " + err);
    };
    reader.readAsArrayBuffer(file);
  }

  // 마커 표시 (개별 마커에 사고유형 번호 라벨 표시)
  function refreshMarkers(){
    if(!isMapInitialized) initMap();
    
    markers.forEach(m => m.setMap(null));
    markers = [];
    markerCluster.clearMarkers();
    
    for(const coord of uploadedCoordinates){
      const marker = new google.maps.Marker({
        position: {lat: coord.lat, lng: coord.lng},
        label: {
          text: coord.accident, // 사고유형 번호를 표시 (텍스트)
          color: 'white',
          fontSize: '14px',
          fontWeight: 'bold'
        }
      });
      marker.addListener('click', () => {
        updateInfoPanel(coord);
        openInfoPanel();
      });
      markers.push(marker);
    }
    markerCluster.addMarkers(markers);
    
    map.setCenter({lat: 35.8, lng: 127.7});
    map.setZoom(7);
  }
  
  window.onload = function(){
    document.getElementById('pageMap').classList.add('active');
    document.querySelectorAll('.submenu-item')[0].classList.add('active');
    initMap();
  };
</script>
</body>
</html>
